
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../add_electricity/">
      
      
        <link rel="next" href="../build_biomass_potential/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.17">
    
    
      
        <title>Add existing baseyear - PyPSA China Model (PIK edition) Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.7e37652d.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#add_existing_baseyear" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="PyPSA China Model (PIK edition) Documentation" class="md-header__button md-logo" aria-label="PyPSA China Model (PIK edition) Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            PyPSA China Model (PIK edition) Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Add existing baseyear
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="PyPSA China Model (PIK edition) Documentation" class="md-nav__button md-logo" aria-label="PyPSA China Model (PIK edition) Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    PyPSA China Model (PIK edition) Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Welcome to the PyPSA-China (PIK version) documentation
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Tutorials
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../SUMMARY/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    SUMMARY
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../add_brownfield/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Add brownfield
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../add_electricity/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Add electricity
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Add existing baseyear
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Add existing baseyear
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#add_existing_baseyear" class="md-nav__link">
    <span class="md-ellipsis">
      add_existing_baseyear
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#add_existing_baseyear.add_build_year_to_new_assets" class="md-nav__link">
    <span class="md-ellipsis">
      add_build_year_to_new_assets
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#add_existing_baseyear.add_existing_vre_capacities" class="md-nav__link">
    <span class="md-ellipsis">
      add_existing_vre_capacities
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#add_existing_baseyear.add_paid_off_capacity" class="md-nav__link">
    <span class="md-ellipsis">
      add_paid_off_capacity
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#add_existing_baseyear.add_power_capacities_installed_before_baseyear" class="md-nav__link">
    <span class="md-ellipsis">
      add_power_capacities_installed_before_baseyear
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#add_existing_baseyear.distribute_vre_by_grade" class="md-nav__link">
    <span class="md-ellipsis">
      distribute_vre_by_grade
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../build_biomass_potential/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Build biomass potential
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../build_cop_profiles/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Build cop profiles
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../build_cutout/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Build cutout
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../build_load_profiles/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Build load profiles
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../build_population/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Build population
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../build_population_gridcell_map/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Build population gridcell map
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../build_province_shapes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Build province shapes
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../build_renewable_potential/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Build renewable potential
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../build_renewable_profiles/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Build renewable profiles
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../build_solar_thermal_profiles/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Build solar thermal profiles
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../build_temperature_profiles/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Build temperature profiles
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../constants/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Constants
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../determine_availability_matrix/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Determine availability matrix
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fetch_rasters/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Fetch rasters
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fetch_shapes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Fetch shapes
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../functions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Functions
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../make_summary/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Make summary
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../plot_heatmap/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Plot heatmap
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../plot_input_costs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Plot input costs
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../plot_inputs_visualisation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Plot inputs visualisation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../plot_network/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Plot network
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../plot_network_heat/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Plot network heat
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../plot_statistics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Plot statistics
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../plot_summary_all/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Plot summary all
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../plot_time_series/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Plot time series
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../prepare_base_network/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Prepare base network
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../prepare_base_network_2020/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Prepare base network 2020
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../prepare_existing_capacities/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Prepare existing capacities
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../prepare_network/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Prepare network
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../prepare_network_common/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Prepare network common
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../readers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Readers
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../readers_geospatial/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Readers geospatial
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../solve_network/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Solve network
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../solve_network_myopic/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Solve network myopic
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_39" >
        
          
          <label class="md-nav__link" for="__nav_3_39" id="__nav_3_39_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Remind coupling
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_39_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_39">
            <span class="md-nav__icon md-icon"></span>
            Remind coupling
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../remind_coupling/disaggregate_data/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Disaggregate data
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../remind_coupling/generic_etl/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Generic etl
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../remind_coupling/make_pypsa_config/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Make pypsa config
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../remind_coupling/setup/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Setup
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#add_existing_baseyear" class="md-nav__link">
    <span class="md-ellipsis">
      add_existing_baseyear
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#add_existing_baseyear.add_build_year_to_new_assets" class="md-nav__link">
    <span class="md-ellipsis">
      add_build_year_to_new_assets
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#add_existing_baseyear.add_existing_vre_capacities" class="md-nav__link">
    <span class="md-ellipsis">
      add_existing_vre_capacities
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#add_existing_baseyear.add_paid_off_capacity" class="md-nav__link">
    <span class="md-ellipsis">
      add_paid_off_capacity
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#add_existing_baseyear.add_power_capacities_installed_before_baseyear" class="md-nav__link">
    <span class="md-ellipsis">
      add_power_capacities_installed_before_baseyear
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#add_existing_baseyear.distribute_vre_by_grade" class="md-nav__link">
    <span class="md-ellipsis">
      distribute_vre_by_grade
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



  <h1>Add existing baseyear</h1>

<div class="doc doc-object doc-module">



<a id="add_existing_baseyear"></a>
    <div class="doc doc-contents first">

        <p>Functions to add brownfield capacities to the network for a reference year</p>









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="add_existing_baseyear.add_build_year_to_new_assets" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_build_year_to_new_assets</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">baseyear</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>add a build year to new assets</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>n</code>
            </td>
            <td>
                  <code><span title="pypsa.Network">Network</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>the network</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>baseyear</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>year in which optimized assets are built</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>workflow/scripts/add_existing_baseyear.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_build_year_to_new_assets</span><span class="p">(</span><span class="n">n</span><span class="p">:</span> <span class="n">pypsa</span><span class="o">.</span><span class="n">Network</span><span class="p">,</span> <span class="n">baseyear</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;add a build year to new assets</span>

<span class="sd">    Args:</span>
<span class="sd">        n (pypsa.Network): the network</span>
<span class="sd">        baseyear (int): year in which optimized assets are built</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Give assets with lifetimes and no build year the build year baseyear</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">n</span><span class="o">.</span><span class="n">iterate_components</span><span class="p">([</span><span class="s2">&quot;Link&quot;</span><span class="p">,</span> <span class="s2">&quot;Generator&quot;</span><span class="p">,</span> <span class="s2">&quot;Store&quot;</span><span class="p">]):</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="s2">&quot;e&quot;</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;Store&quot;</span> <span class="k">else</span> <span class="s2">&quot;p&quot;</span>

        <span class="n">assets</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[(</span><span class="n">c</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">lifetime</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">attr</span> <span class="o">+</span> <span class="s2">&quot;_nom_extendable&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">)]</span>

        <span class="c1"># add -baseyear to name</span>
        <span class="n">renamed</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">renamed</span><span class="p">[</span><span class="n">assets</span><span class="p">]</span> <span class="o">+=</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">baseyear</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">renamed</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">assets</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span>
            <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">lifetime</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">attr</span> <span class="o">+</span> <span class="s2">&quot;_nom_extendable&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">build_year</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">c</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">assets</span><span class="p">,</span> <span class="s2">&quot;build_year&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">baseyear</span>

        <span class="c1"># rename time-dependent</span>
        <span class="n">selection</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">component_attrs</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;series&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">n</span><span class="o">.</span><span class="n">component_attrs</span><span class="p">[</span>
            <span class="n">c</span><span class="o">.</span><span class="n">name</span>
        <span class="p">]</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;Input&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">n</span><span class="o">.</span><span class="n">component_attrs</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">selection</span><span class="p">]:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">pnl</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">renamed</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="add_existing_baseyear.add_existing_vre_capacities" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_existing_vre_capacities</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">costs</span><span class="p">,</span> <span class="n">vre_caps</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Add existing VRE capacities to the network and distribute them by vre grade potential.
Adapted from pypsa-eur but the VRE capacities are province resolved.</p>
<p>NOTE that using this function requires adding the land-use constraint in solve_network so
  that the existing capacities are subtracted from the available potential</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>n</code>
            </td>
            <td>
                  <code><span title="pypsa.Network">Network</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>the network</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>costs</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>costs of the technologies</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>vre_caps</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>existing VRE capacities in MW</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>config</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>snakemake configuration dictionary</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Returns:
    pd.DataFrame: DataFrame with existing VRE capacities distributed by CF grade</p>


            <details class="quote">
              <summary>Source code in <code>workflow/scripts/add_existing_baseyear.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_existing_vre_capacities</span><span class="p">(</span>
    <span class="n">n</span><span class="p">:</span> <span class="n">pypsa</span><span class="o">.</span><span class="n">Network</span><span class="p">,</span>
    <span class="n">costs</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">vre_caps</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add existing VRE capacities to the network and distribute them by vre grade potential.</span>
<span class="sd">    Adapted from pypsa-eur but the VRE capacities are province resolved.</span>

<span class="sd">    NOTE that using this function requires adding the land-use constraint in solve_network so</span>
<span class="sd">      that the existing capacities are subtracted from the available potential</span>

<span class="sd">    Args:</span>
<span class="sd">        n (pypsa.Network): the network</span>
<span class="sd">        costs (pd.DataFrame): costs of the technologies</span>
<span class="sd">        vre_caps (pd.DataFrame): existing VRE capacities in MW</span>
<span class="sd">        config (dict): snakemake configuration dictionary</span>
<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: DataFrame with existing VRE capacities distributed by CF grade</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">tech_map</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;solar&quot;</span><span class="p">:</span> <span class="s2">&quot;PV&quot;</span><span class="p">,</span> <span class="s2">&quot;onwind&quot;</span><span class="p">:</span> <span class="s2">&quot;Onshore&quot;</span><span class="p">,</span> <span class="s2">&quot;offwind-ac&quot;</span><span class="p">:</span> <span class="s2">&quot;Offshore&quot;</span><span class="p">,</span> <span class="s2">&quot;offwind&quot;</span><span class="p">:</span> <span class="s2">&quot;Offshore&quot;</span><span class="p">}</span>
    <span class="n">tech_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">tech_map</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">tech_map</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;Techs&quot;</span><span class="p">][</span><span class="s2">&quot;vre_techs&quot;</span><span class="p">]}</span>

    <span class="n">grouped_vre</span> <span class="o">=</span> <span class="n">vre_caps</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;Tech&quot;</span><span class="p">,</span> <span class="s2">&quot;bus&quot;</span><span class="p">,</span> <span class="s2">&quot;DateIn&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">Capacity</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">vre_df</span> <span class="o">=</span> <span class="n">grouped_vre</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">df_agg</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">carrier</span> <span class="ow">in</span> <span class="n">tech_map</span><span class="p">:</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">vre_df</span><span class="p">[</span><span class="n">vre_df</span><span class="o">.</span><span class="n">Tech</span> <span class="o">==</span> <span class="n">carrier</span><span class="p">]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Tech&quot;</span><span class="p">])</span>
        <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;bus&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="c1"># fetch existing vre generators (n grade bins per node)</span>
        <span class="n">gen_i</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">generators</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;carrier == @carrier&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">index</span>
        <span class="n">carrier_gens</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">generators</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">gen_i</span><span class="p">]</span>
        <span class="n">res_capacities</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># for each bus, distribute the vre capacities by grade potential - best first</span>
        <span class="k">for</span> <span class="n">bus</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">carrier_gens</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;bus&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">bus</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">res_capacities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">distribute_vre_by_grade</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">p_nom_max</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">bus</span><span class="p">]))</span>

        <span class="k">if</span> <span class="n">res_capacities</span><span class="p">:</span>
            <span class="n">res_capacities</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">res_capacities</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">gen</span> <span class="ow">in</span> <span class="n">res_capacities</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                    <span class="n">bus_bin</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">carrier</span><span class="si">}</span><span class="s2">.*&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">gen</span><span class="p">)</span>
                    <span class="n">bus</span><span class="p">,</span> <span class="n">bin_id</span> <span class="o">=</span> <span class="n">bus_bin</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bus_bin</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">carrier</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">capacity</span> <span class="o">=</span> <span class="n">res_capacities</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">gen</span><span class="p">,</span> <span class="n">year</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">capacity</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                        <span class="n">cost_key</span> <span class="o">=</span> <span class="n">carrier</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">df_agg</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;Fueltype&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">carrier</span>
                        <span class="n">df_agg</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;Capacity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">capacity</span>
                        <span class="n">df_agg</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;DateIn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
                        <span class="n">df_agg</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;grouping_year&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
                        <span class="n">df_agg</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;lifetime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">costs</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">cost_key</span><span class="p">,</span> <span class="s2">&quot;lifetime&quot;</span><span class="p">]</span>
                        <span class="n">df_agg</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;DateOut&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">year</span> <span class="o">+</span> <span class="n">costs</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">cost_key</span><span class="p">,</span> <span class="s2">&quot;lifetime&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
                        <span class="n">df_agg</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;bus&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bus</span>
                        <span class="n">df_agg</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;resource_class&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bin_id</span>

    <span class="k">if</span> <span class="n">df_agg</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df_agg</span>

    <span class="n">df_agg</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;Tech&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_agg</span><span class="o">.</span><span class="n">Fueltype</span>
    <span class="k">return</span> <span class="n">df_agg</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="add_existing_baseyear.add_paid_off_capacity" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_paid_off_capacity</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">paid_off_caps</span><span class="p">,</span> <span class="n">costs</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Add capacities that have been paid off to the network. This is intended
for REMIND coupling, where (some of) the REMIND investments can be freely allocated
to the optimal node. NB: an additional constraing is needed to ensure that
the capacity is not exceeded.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>network</code>
            </td>
            <td>
                  <code><span title="pypsa.Network">Network</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>the network to which the capacities are added.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>paid_off_caps</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame with paid off capacities &amp; columns
[tech_group, Capacity, techs]</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>costs</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>techno-economic data for the technologies</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>cutoff</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>minimum capacity to be considered. Defaults to 100 MW.</p>
              </div>
            </td>
            <td>
                  <code>100</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>workflow/scripts/add_existing_baseyear.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_paid_off_capacity</span><span class="p">(</span>
    <span class="n">network</span><span class="p">:</span> <span class="n">pypsa</span><span class="o">.</span><span class="n">Network</span><span class="p">,</span> <span class="n">paid_off_caps</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">costs</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="mi">100</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add capacities that have been paid off to the network. This is intended</span>
<span class="sd">    for REMIND coupling, where (some of) the REMIND investments can be freely allocated</span>
<span class="sd">    to the optimal node. NB: an additional constraing is needed to ensure that</span>
<span class="sd">    the capacity is not exceeded.</span>

<span class="sd">    Args:</span>
<span class="sd">        network (pypsa.Network): the network to which the capacities are added.</span>
<span class="sd">        paid_off_caps (pd.DataFrame): DataFrame with paid off capacities &amp; columns</span>
<span class="sd">            [tech_group, Capacity, techs]</span>
<span class="sd">        costs (pd.DataFrame): techno-economic data for the technologies</span>
<span class="sd">        cutoff (int, optional): minimum capacity to be considered. Defaults to 100 MW.&quot;&quot;&quot;</span>

    <span class="n">paid_off</span> <span class="o">=</span> <span class="n">paid_off_caps</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

    <span class="c1"># explode tech list per tech group (constraint will apply to group)</span>
    <span class="n">paid_off</span><span class="o">.</span><span class="n">techs</span> <span class="o">=</span> <span class="n">paid_off</span><span class="o">.</span><span class="n">techs</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">to_list</span><span class="p">)</span>
    <span class="n">paid_off</span> <span class="o">=</span> <span class="n">paid_off</span><span class="o">.</span><span class="n">explode</span><span class="p">(</span><span class="s2">&quot;techs&quot;</span><span class="p">)</span>
    <span class="n">paid_off</span><span class="p">[</span><span class="s2">&quot;carrier&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">paid_off</span><span class="o">.</span><span class="n">techs</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">paid_off</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;carrier&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># clip small capacities</span>
    <span class="n">paid_off</span><span class="p">[</span><span class="s2">&quot;p_nom_max&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">paid_off</span><span class="o">.</span><span class="n">Capacity</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">cutoff</span> <span class="k">else</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">paid_off</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Capacity&quot;</span><span class="p">,</span> <span class="s2">&quot;techs&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">paid_off</span> <span class="o">=</span> <span class="n">paid_off</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;p_nom_max &gt; 0&quot;</span><span class="p">)</span>

    <span class="n">component_settings</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;Generator&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;join_col&quot;</span><span class="p">:</span> <span class="s2">&quot;carrier&quot;</span><span class="p">,</span>
            <span class="s2">&quot;attrs_to_fix&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;p_min_pu&quot;</span><span class="p">,</span> <span class="s2">&quot;p_max_pu&quot;</span><span class="p">],</span>
        <span class="p">},</span>
        <span class="s2">&quot;Link&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;join_col&quot;</span><span class="p">:</span> <span class="s2">&quot;carrier&quot;</span><span class="p">,</span>
            <span class="s2">&quot;attrs_to_fix&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;p_min_pu&quot;</span><span class="p">,</span> <span class="s2">&quot;p_max_pu&quot;</span><span class="p">,</span> <span class="s2">&quot;efficiency&quot;</span><span class="p">,</span> <span class="s2">&quot;efficiency2&quot;</span><span class="p">],</span>
        <span class="p">},</span>
        <span class="s2">&quot;Store&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;join_col&quot;</span><span class="p">:</span> <span class="s2">&quot;carrier&quot;</span><span class="p">,</span>
            <span class="s2">&quot;attrs_to_fix&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">},</span>
    <span class="p">}</span>

    <span class="c1"># TODO make a centralised setting or update cpl config</span>
    <span class="n">rename_carriers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;OCGT&quot;</span><span class="p">:</span> <span class="s2">&quot;gas OCGT&quot;</span><span class="p">,</span> <span class="s2">&quot;CCGT&quot;</span><span class="p">:</span> <span class="s2">&quot;gas CCGT&quot;</span><span class="p">}</span>
    <span class="n">paid_off</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">rename_carriers</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">component</span><span class="p">,</span> <span class="n">settings</span> <span class="ow">in</span> <span class="n">component_settings</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;e&quot;</span> <span class="k">if</span> <span class="n">component</span> <span class="o">==</span> <span class="s2">&quot;Store&quot;</span> <span class="k">else</span> <span class="s2">&quot;p&quot;</span>
        <span class="n">paid_off_comp</span> <span class="o">=</span> <span class="n">paid_off</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;p_nom_max&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_nom_max&quot;</span><span class="p">})</span>

        <span class="c1"># exclude brownfield capacities</span>
        <span class="n">df</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">component</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;s&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_nom_extendable == True&quot;</span><span class="p">)</span>
        <span class="c1"># join will add the tech_group and p_nom_max_rcl columns, used later for constraints</span>
        <span class="c1"># rcl is legacy name from Adrian for region country limit</span>
        <span class="n">paid</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">paid_off_comp</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;join_col&quot;</span><span class="p">]],</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">rsuffix</span><span class="o">=</span><span class="s2">&quot;_rcl&quot;</span><span class="p">)</span>
        <span class="n">paid</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_nom_max&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_nom_max_rcl&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">paid</span> <span class="o">=</span> <span class="n">paid</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">paid</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">dropna</span><span class="p">()]</span>
        <span class="k">if</span> <span class="n">paid</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># REMIND cap is in output, PyPSA link in input</span>
        <span class="k">if</span> <span class="n">component</span> <span class="o">==</span> <span class="s2">&quot;Link&quot;</span><span class="p">:</span>
            <span class="n">paid</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;p_nom_max_rcl&quot;</span><span class="p">]</span> <span class="o">/=</span> <span class="n">paid</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;efficiency&quot;</span><span class="p">]</span>

        <span class="n">paid</span><span class="o">.</span><span class="n">index</span> <span class="o">+=</span> <span class="s2">&quot;_paid_off&quot;</span>
        <span class="c1"># set permissive options for the paid-off capacities (constraint per group added to model later)</span>
        <span class="n">paid</span><span class="p">[</span><span class="s2">&quot;capital_cost&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">paid</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_nom_min&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">paid</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_nom&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">paid</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_nom_max&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>

        <span class="c1"># add to the network</span>
        <span class="n">network</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">component</span><span class="p">,</span> <span class="n">paid</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="o">**</span><span class="n">paid</span><span class="p">)</span>
        <span class="c1"># now add the dynamic attributes not carried over by n.add (per unit avail etc)</span>
        <span class="k">for</span> <span class="n">missing_attr</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;attrs_to_fix&quot;</span><span class="p">]:</span>
            <span class="n">df_t</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">component</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;s_t&quot;</span><span class="p">)[</span><span class="n">missing_attr</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">df_t</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">base_cols</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">paid</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_paid_off&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df_t</span><span class="o">.</span><span class="n">columns</span>
                <span class="p">]</span>
                <span class="n">df_t</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">(</span><span class="n">base_cols</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_paid_off&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_t</span><span class="p">[</span><span class="n">base_cols</span><span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                    <span class="n">columns</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="s2">&quot;_paid_off&quot;</span>
                <span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;biomass&quot;</span> <span class="ow">in</span> <span class="n">paid_off</span><span class="o">.</span><span class="n">index</span> <span class="ow">and</span> <span class="s2">&quot;biomass&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">network</span><span class="o">.</span><span class="n">generators</span><span class="o">.</span><span class="n">carrier</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
        <span class="n">_add_paidoff_biomass</span><span class="p">(</span>
            <span class="n">network</span><span class="p">,</span>
            <span class="n">costs</span><span class="p">,</span>
            <span class="n">paid_off</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;biomass&quot;</span><span class="p">,</span> <span class="s2">&quot;p_nom_max&quot;</span><span class="p">],</span>
            <span class="n">tech_group</span><span class="o">=</span><span class="n">paid_off</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;biomass&quot;</span><span class="p">,</span> <span class="s2">&quot;tech_group&quot;</span><span class="p">],</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="add_existing_baseyear.add_power_capacities_installed_before_baseyear" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_power_capacities_installed_before_baseyear</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">costs</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">installed_capacities</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Add existing power capacities to the network</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>n</code>
            </td>
            <td>
                  <code><span title="pypsa.Network">Network</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>the network</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>costs</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>techno-economic data</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>config</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>configuration dictionary</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>installed_capacities</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>installed capacities in MW</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>workflow/scripts/add_existing_baseyear.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_power_capacities_installed_before_baseyear</span><span class="p">(</span>
    <span class="n">n</span><span class="p">:</span> <span class="n">pypsa</span><span class="o">.</span><span class="n">Network</span><span class="p">,</span>
    <span class="n">costs</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">installed_capacities</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add existing power capacities to the network</span>

<span class="sd">    Args:</span>
<span class="sd">        n (pypsa.Network): the network</span>
<span class="sd">        costs (pd.DataFrame): techno-economic data</span>
<span class="sd">        config (dict): configuration dictionary</span>
<span class="sd">        installed_capacities (pd.DataFrame): installed capacities in MW</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;adding power capacities installed before baseyear&quot;</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">installed_capacities</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="c1"># fix fuel type CHP order to match network</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;tech_clean&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Fueltype&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^CHP (.+)$&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\1 CHP&quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;tech_clean&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;tech_clean&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;central &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;tech_clean&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;tech_clean&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;decentral &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="c1"># TODO fix this based on config / centralise / other</span>
    <span class="n">carrier_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;coal&quot;</span><span class="p">:</span> <span class="s2">&quot;coal&quot;</span><span class="p">,</span>
        <span class="s2">&quot;coal power plant&quot;</span><span class="p">:</span> <span class="s2">&quot;coal&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CHP coal&quot;</span><span class="p">:</span> <span class="s2">&quot;CHP coal&quot;</span><span class="p">,</span>
        <span class="s2">&quot;coal CHP&quot;</span><span class="p">:</span> <span class="s2">&quot;CHP coal&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CHP gas&quot;</span><span class="p">:</span> <span class="s2">&quot;CHP gas&quot;</span><span class="p">,</span>
        <span class="s2">&quot;gas CHP&quot;</span><span class="p">:</span> <span class="s2">&quot;CHP gas&quot;</span><span class="p">,</span>
        <span class="s2">&quot;gas OCGT&quot;</span><span class="p">:</span> <span class="s2">&quot;gas OCGT&quot;</span><span class="p">,</span>
        <span class="s2">&quot;gas CCGT&quot;</span><span class="p">:</span> <span class="s2">&quot;gas CCGT&quot;</span><span class="p">,</span>
        <span class="s2">&quot;solar&quot;</span><span class="p">:</span> <span class="s2">&quot;solar&quot;</span><span class="p">,</span>
        <span class="s2">&quot;solar thermal&quot;</span><span class="p">:</span> <span class="s2">&quot;solar thermal&quot;</span><span class="p">,</span>
        <span class="s2">&quot;onwind&quot;</span><span class="p">:</span> <span class="s2">&quot;onwind&quot;</span><span class="p">,</span>
        <span class="s2">&quot;offwind&quot;</span><span class="p">:</span> <span class="s2">&quot;offwind&quot;</span><span class="p">,</span>
        <span class="s2">&quot;coal boiler&quot;</span><span class="p">:</span> <span class="s2">&quot;coal boiler&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ground-sourced heat pump&quot;</span><span class="p">:</span> <span class="s2">&quot;heat pump&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ground heat pump&quot;</span><span class="p">:</span> <span class="s2">&quot;heat pump&quot;</span><span class="p">,</span>
        <span class="s2">&quot;air heat pump&quot;</span><span class="p">:</span> <span class="s2">&quot;heat pump&quot;</span><span class="p">,</span>
        <span class="s2">&quot;nuclear&quot;</span><span class="p">:</span> <span class="s2">&quot;nuclear&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">costs_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;coal power plant&quot;</span><span class="p">:</span> <span class="s2">&quot;coal&quot;</span><span class="p">,</span>
        <span class="s2">&quot;coal CHP&quot;</span><span class="p">:</span> <span class="s2">&quot;central coal CHP&quot;</span><span class="p">,</span>
        <span class="s2">&quot;gas CHP&quot;</span><span class="p">:</span> <span class="s2">&quot;central gas CHP&quot;</span><span class="p">,</span>
        <span class="s2">&quot;gas OCGT&quot;</span><span class="p">:</span> <span class="s2">&quot;OCGT&quot;</span><span class="p">,</span>
        <span class="s2">&quot;gas CCGT&quot;</span><span class="p">:</span> <span class="s2">&quot;CCGT&quot;</span><span class="p">,</span>
        <span class="s2">&quot;solar&quot;</span><span class="p">:</span> <span class="s2">&quot;solar&quot;</span><span class="p">,</span>
        <span class="s2">&quot;solar thermal&quot;</span><span class="p">:</span> <span class="s2">&quot;central solar thermal&quot;</span><span class="p">,</span>
        <span class="s2">&quot;onwind&quot;</span><span class="p">:</span> <span class="s2">&quot;onwind&quot;</span><span class="p">,</span>
        <span class="s2">&quot;offwind&quot;</span><span class="p">:</span> <span class="s2">&quot;offwind&quot;</span><span class="p">,</span>
        <span class="s2">&quot;coal boiler&quot;</span><span class="p">:</span> <span class="s2">&quot;central coal boier&quot;</span><span class="p">,</span>
        <span class="s2">&quot;heat pump&quot;</span><span class="p">:</span> <span class="s2">&quot;central ground-sourced heat pump&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ground-sourced heat pump&quot;</span><span class="p">:</span> <span class="s2">&quot;central ground-sourced heat pump&quot;</span><span class="p">,</span>
        <span class="s2">&quot;nuclear&quot;</span><span class="p">:</span> <span class="s2">&quot;nuclear&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1"># add techs that may have a direct match to the technoecon data</span>
    <span class="n">missing_techs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">Fueltype</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">costs_map</span><span class="p">}</span>
    <span class="n">costs_map</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">missing_techs</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;resource_class&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;resource_class&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">resource_class</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">grouping_year</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">grouping_year</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;existing_capacities&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;collapse_years&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">df</span><span class="o">.</span><span class="n">grouping_year</span> <span class="o">=</span> <span class="s2">&quot;brownwfield&quot;</span>

    <span class="n">df_</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span>
        <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;grouping_year&quot;</span><span class="p">,</span> <span class="s2">&quot;tech_clean&quot;</span><span class="p">,</span> <span class="s2">&quot;resource_class&quot;</span><span class="p">],</span>
        <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;bus&quot;</span><span class="p">,</span>
        <span class="n">values</span><span class="o">=</span><span class="s2">&quot;Capacity&quot;</span><span class="p">,</span>
        <span class="n">aggfunc</span><span class="o">=</span><span class="s2">&quot;sum&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">df_</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">defined_carriers</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">carriers</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
    <span class="n">vre_carriers</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;solar&quot;</span><span class="p">,</span> <span class="s2">&quot;onwind&quot;</span><span class="p">,</span> <span class="s2">&quot;offwind&quot;</span><span class="p">]</span>
    <span class="n">vre_carriers</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;solar&quot;</span><span class="p">,</span> <span class="s2">&quot;onwind&quot;</span><span class="p">,</span> <span class="s2">&quot;offwind&quot;</span><span class="p">]</span>

    <span class="c1"># TODO do we really need to loop over the years? / so many things?</span>
    <span class="c1"># something like df_.unstack(level=0) would be more efficient</span>
    <span class="k">for</span> <span class="n">grouping_year</span><span class="p">,</span> <span class="n">generator</span><span class="p">,</span> <span class="n">resource_grade</span> <span class="ow">in</span> <span class="n">df_</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="n">build_year</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">grouping_year</span> <span class="o">==</span> <span class="s2">&quot;brownwfield&quot;</span> <span class="k">else</span> <span class="n">grouping_year</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding existing generator </span><span class="si">{</span><span class="n">generator</span><span class="si">}</span><span class="s2"> with year grp </span><span class="si">{</span><span class="n">grouping_year</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">carrier_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">generator</span><span class="p">,</span> <span class="s2">&quot;missing&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">defined_carriers</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Carrier </span><span class="si">{</span><span class="n">carrier_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">generator</span><span class="p">,</span><span class="w"> </span><span class="kc">None</span><span class="p">)</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">generator</span><span class="si">}</span><span class="s2"> not defined in network - added anyway&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">costs_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">generator</span><span class="si">}</span><span class="s2"> not defined in technoecon map - check costs_map&quot;</span><span class="p">)</span>

        <span class="c1"># capacity is the capacity in MW at each node for this</span>
        <span class="n">capacity</span> <span class="o">=</span> <span class="n">df_</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">grouping_year</span><span class="p">,</span> <span class="n">generator</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">capacity</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="c1"># fix index for network.add (merge grade to name)</span>
        <span class="n">capacity</span> <span class="o">=</span> <span class="n">capacity</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span>
        <span class="n">capacity</span> <span class="o">=</span> <span class="n">capacity</span><span class="p">[</span><span class="o">~</span><span class="n">capacity</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span>
        <span class="n">capacity</span> <span class="o">=</span> <span class="n">capacity</span><span class="p">[</span><span class="n">capacity</span> <span class="o">&gt;</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;existing_capacities&quot;</span><span class="p">][</span><span class="s2">&quot;threshold_capacity&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="n">buses</span> <span class="o">=</span> <span class="n">capacity</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">capacity</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">capacity</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">capacity</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">capacity</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">capacity</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">costs_map</span><span class="p">[</span><span class="n">generator</span><span class="p">]</span>

        <span class="n">costs_key</span> <span class="o">=</span> <span class="n">costs_map</span><span class="p">[</span><span class="n">generator</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">generator</span> <span class="ow">in</span> <span class="n">vre_carriers</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">generators_t</span><span class="o">.</span><span class="n">p_max_pu</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">generators</span><span class="o">.</span><span class="n">carrier</span><span class="p">)</span> <span class="o">==</span> <span class="n">generator</span>
            <span class="n">p_max_pu</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">generators_t</span><span class="o">.</span><span class="n">p_max_pu</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span>
            <span class="n">n</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                <span class="s2">&quot;Generator&quot;</span><span class="p">,</span>
                <span class="n">capacity</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                <span class="n">suffix</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;-</span><span class="si">{</span><span class="n">grouping_year</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">bus</span><span class="o">=</span><span class="n">buses</span><span class="p">,</span>
                <span class="n">carrier</span><span class="o">=</span><span class="n">carrier_map</span><span class="p">[</span><span class="n">generator</span><span class="p">],</span>
                <span class="n">p_nom</span><span class="o">=</span><span class="n">capacity</span><span class="p">,</span>
                <span class="n">p_nom_min</span><span class="o">=</span><span class="n">capacity</span><span class="p">,</span>
                <span class="n">p_nom_extendable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">marginal_cost</span><span class="o">=</span><span class="n">costs</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">costs_key</span><span class="p">,</span> <span class="s2">&quot;marginal_cost&quot;</span><span class="p">],</span>
                <span class="n">efficiency</span><span class="o">=</span><span class="n">costs</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">costs_key</span><span class="p">,</span> <span class="s2">&quot;efficiency&quot;</span><span class="p">],</span>
                <span class="n">p_max_pu</span><span class="o">=</span><span class="n">p_max_pu</span><span class="p">[</span><span class="n">capacity</span><span class="o">.</span><span class="n">index</span><span class="p">],</span>
                <span class="n">build_year</span><span class="o">=</span><span class="n">build_year</span><span class="p">,</span>
                <span class="n">lifetime</span><span class="o">=</span><span class="n">costs</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">costs_key</span><span class="p">,</span> <span class="s2">&quot;lifetime&quot;</span><span class="p">],</span>
                <span class="n">location</span><span class="o">=</span><span class="n">buses</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="n">generator</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;nuclear&quot;</span><span class="p">,</span> <span class="s2">&quot;coal power plant&quot;</span><span class="p">,</span> <span class="s2">&quot;biomass&quot;</span><span class="p">,</span> <span class="s2">&quot;oil&quot;</span><span class="p">]:</span>
            <span class="n">n</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                <span class="s2">&quot;Generator&quot;</span><span class="p">,</span>
                <span class="n">capacity</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">grouping_year</span><span class="p">),</span>
                <span class="n">bus</span><span class="o">=</span><span class="n">buses</span><span class="p">,</span>
                <span class="n">carrier</span><span class="o">=</span><span class="n">carrier_map</span><span class="p">[</span><span class="n">generator</span><span class="p">],</span>
                <span class="n">p_nom</span><span class="o">=</span><span class="n">capacity</span><span class="p">,</span>
                <span class="n">p_nom_min</span><span class="o">=</span><span class="n">capacity</span><span class="p">,</span>
                <span class="n">p_nom_extendable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">p_max_pu</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;nuclear_reactors&quot;</span><span class="p">][</span><span class="s2">&quot;p_max_pu&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">generator</span> <span class="o">==</span> <span class="s2">&quot;nuclear&quot;</span> <span class="k">else</span> <span class="mi">1</span><span class="p">,</span>
                <span class="n">p_min_pu</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;nuclear_reactors&quot;</span><span class="p">][</span><span class="s2">&quot;p_min_pu&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">generator</span> <span class="o">==</span> <span class="s2">&quot;nuclear&quot;</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
                <span class="n">marginal_cost</span><span class="o">=</span><span class="n">costs</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">costs_key</span><span class="p">,</span> <span class="s2">&quot;marginal_cost&quot;</span><span class="p">],</span>
                <span class="n">efficiency</span><span class="o">=</span><span class="n">costs</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">costs_key</span><span class="p">,</span> <span class="s2">&quot;efficiency&quot;</span><span class="p">],</span>
                <span class="n">build_year</span><span class="o">=</span><span class="n">build_year</span><span class="p">,</span>
                <span class="n">lifetime</span><span class="o">=</span><span class="n">costs</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">costs_key</span><span class="p">,</span> <span class="s2">&quot;lifetime&quot;</span><span class="p">],</span>
                <span class="n">location</span><span class="o">=</span><span class="n">buses</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># TODO this does not add the carrier to the list</span>
        <span class="k">elif</span> <span class="n">generator</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;gas CCGT&quot;</span><span class="p">,</span> <span class="s2">&quot;gas OCGT&quot;</span><span class="p">]:</span>
            <span class="n">bus0</span> <span class="o">=</span> <span class="n">buses</span> <span class="o">+</span> <span class="s2">&quot; gas&quot;</span>
            <span class="n">carrier_</span> <span class="o">=</span> <span class="n">carrier_map</span><span class="p">[</span><span class="n">generator</span><span class="p">]</span>
            <span class="c1"># ugly fix to register the carrier. Emissions for sub carrier are 0: they are accounted for at gas bus</span>
            <span class="n">n</span><span class="o">.</span><span class="n">carriers</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">carrier_</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;co2_emissions&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="n">snakemake</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;plotting&quot;</span><span class="p">][</span><span class="s2">&quot;tech_colors&quot;</span><span class="p">][</span><span class="n">carrier_</span><span class="p">],</span>
                <span class="s2">&quot;nice_name&quot;</span><span class="p">:</span> <span class="n">snakemake</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;plotting&quot;</span><span class="p">][</span><span class="s2">&quot;nice_names&quot;</span><span class="p">][</span><span class="n">carrier_</span><span class="p">],</span>
                <span class="s2">&quot;max_growth&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
                <span class="s2">&quot;max_relative_growth&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="c1"># now add link - carrier should exist</span>
            <span class="n">n</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                <span class="s2">&quot;Link&quot;</span><span class="p">,</span>
                <span class="n">capacity</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">grouping_year</span><span class="p">),</span>
                <span class="n">bus0</span><span class="o">=</span><span class="n">bus0</span><span class="p">,</span>
                <span class="n">bus1</span><span class="o">=</span><span class="n">buses</span><span class="p">,</span>
                <span class="n">carrier</span><span class="o">=</span><span class="n">carrier_map</span><span class="p">[</span><span class="n">generator</span><span class="p">],</span>
                <span class="n">marginal_cost</span><span class="o">=</span><span class="n">costs</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">costs_key</span><span class="p">,</span> <span class="s2">&quot;efficiency&quot;</span><span class="p">]</span>
                <span class="o">*</span> <span class="n">costs</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">costs_key</span><span class="p">,</span> <span class="s2">&quot;VOM&quot;</span><span class="p">],</span>  <span class="c1"># NB: VOM is per MWel</span>
                <span class="c1"># NB: fixed cost is per MWel</span>
                <span class="n">p_nom</span><span class="o">=</span><span class="n">capacity</span> <span class="o">/</span> <span class="n">costs</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">costs_key</span><span class="p">,</span> <span class="s2">&quot;efficiency&quot;</span><span class="p">],</span>
                <span class="n">p_nom_min</span><span class="o">=</span><span class="n">capacity</span> <span class="o">/</span> <span class="n">costs</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">costs_key</span><span class="p">,</span> <span class="s2">&quot;efficiency&quot;</span><span class="p">],</span>
                <span class="n">p_nom_extendable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">efficiency</span><span class="o">=</span><span class="n">costs</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">costs_key</span><span class="p">,</span> <span class="s2">&quot;efficiency&quot;</span><span class="p">],</span>
                <span class="n">build_year</span><span class="o">=</span><span class="n">build_year</span><span class="p">,</span>
                <span class="n">lifetime</span><span class="o">=</span><span class="n">costs</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">costs_key</span><span class="p">,</span> <span class="s2">&quot;lifetime&quot;</span><span class="p">],</span>
                <span class="n">location</span><span class="o">=</span><span class="n">buses</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">generator</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s2">&quot;solar thermal&quot;</span><span class="p">,</span>
            <span class="s2">&quot;CHP coal&quot;</span><span class="p">,</span>
            <span class="s2">&quot;CHP gas&quot;</span><span class="p">,</span>
            <span class="s2">&quot;heat pump&quot;</span><span class="p">,</span>
            <span class="s2">&quot;coal boiler&quot;</span><span class="p">,</span>
        <span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;heat_coupling&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipped </span><span class="si">{</span><span class="n">generator</span><span class="si">}</span><span class="s2"> because heat coupling is not activated&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">generator</span> <span class="o">==</span> <span class="s2">&quot;solar thermal&quot;</span><span class="p">:</span>
            <span class="n">p_max_pu</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">generators_t</span><span class="o">.</span><span class="n">p_max_pu</span><span class="p">[</span><span class="n">capacity</span><span class="o">.</span><span class="n">index</span> <span class="o">+</span> <span class="s2">&quot; central &quot;</span> <span class="o">+</span> <span class="n">generator</span><span class="p">]</span>
            <span class="n">p_max_pu</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">capacity</span><span class="o">.</span><span class="n">index</span>
            <span class="n">n</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                <span class="s2">&quot;Generator&quot;</span><span class="p">,</span>
                <span class="n">capacity</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                <span class="n">suffix</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;-</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">grouping_year</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">bus</span><span class="o">=</span><span class="n">buses</span> <span class="o">+</span> <span class="s2">&quot; central heat&quot;</span><span class="p">,</span>
                <span class="n">carrier</span><span class="o">=</span><span class="n">carrier_map</span><span class="p">[</span><span class="n">generator</span><span class="p">],</span>
                <span class="n">p_nom</span><span class="o">=</span><span class="n">capacity</span><span class="p">,</span>
                <span class="n">p_nom_min</span><span class="o">=</span><span class="n">capacity</span><span class="p">,</span>
                <span class="n">p_nom_extendable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">marginal_cost</span><span class="o">=</span><span class="n">costs</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="s2">&quot;central &quot;</span> <span class="o">+</span> <span class="n">generator</span><span class="p">,</span> <span class="s2">&quot;marginal_cost&quot;</span><span class="p">],</span>
                <span class="n">p_max_pu</span><span class="o">=</span><span class="n">p_max_pu</span><span class="p">,</span>
                <span class="n">build_year</span><span class="o">=</span><span class="n">build_year</span><span class="p">,</span>
                <span class="n">lifetime</span><span class="o">=</span><span class="n">costs</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="s2">&quot;central &quot;</span> <span class="o">+</span> <span class="n">generator</span><span class="p">,</span> <span class="s2">&quot;lifetime&quot;</span><span class="p">],</span>
                <span class="n">location</span><span class="o">=</span><span class="n">buses</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="n">generator</span> <span class="o">==</span> <span class="s2">&quot;CHP coal&quot;</span><span class="p">:</span>
            <span class="n">bus0</span> <span class="o">=</span> <span class="n">buses</span> <span class="o">+</span> <span class="s2">&quot; coal&quot;</span>
            <span class="c1"># TODO soft-code efficiency !!</span>
            <span class="n">hist_efficiency</span> <span class="o">=</span> <span class="mf">0.37</span>
            <span class="n">n</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                <span class="s2">&quot;Link&quot;</span><span class="p">,</span>
                <span class="n">capacity</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                <span class="n">suffix</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;-</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">grouping_year</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">bus0</span><span class="o">=</span><span class="n">bus0</span><span class="p">,</span>
                <span class="n">bus1</span><span class="o">=</span><span class="n">capacity</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                <span class="n">carrier</span><span class="o">=</span><span class="n">carrier_map</span><span class="p">[</span><span class="n">generator</span><span class="p">],</span>
                <span class="n">marginal_cost</span><span class="o">=</span><span class="n">hist_efficiency</span>
                <span class="o">*</span> <span class="n">costs</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="s2">&quot;central coal CHP&quot;</span><span class="p">,</span> <span class="s2">&quot;VOM&quot;</span><span class="p">],</span>  <span class="c1"># NB: VOM is per MWel</span>
                <span class="n">p_nom</span><span class="o">=</span><span class="n">capacity</span> <span class="o">/</span> <span class="n">hist_efficiency</span><span class="p">,</span>
                <span class="n">p_nom_min</span><span class="o">=</span><span class="n">capacity</span> <span class="o">/</span> <span class="n">hist_efficiency</span><span class="p">,</span>
                <span class="n">p_nom_extendable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">efficiency</span><span class="o">=</span><span class="n">hist_efficiency</span><span class="p">,</span>
                <span class="n">p_nom_ratio</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                <span class="n">c_b</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span>
                <span class="n">build_year</span><span class="o">=</span><span class="n">build_year</span><span class="p">,</span>
                <span class="n">lifetime</span><span class="o">=</span><span class="n">costs</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="s2">&quot;central coal CHP&quot;</span><span class="p">,</span> <span class="s2">&quot;lifetime&quot;</span><span class="p">],</span>
                <span class="n">location</span><span class="o">=</span><span class="n">buses</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">n</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                <span class="s2">&quot;Link&quot;</span><span class="p">,</span>
                <span class="n">capacity</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                <span class="n">suffix</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot; boiler-</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">grouping_year</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">bus0</span><span class="o">=</span><span class="n">bus0</span><span class="p">,</span>
                <span class="n">bus1</span><span class="o">=</span><span class="n">capacity</span><span class="o">.</span><span class="n">index</span> <span class="o">+</span> <span class="s2">&quot; central heat&quot;</span><span class="p">,</span>
                <span class="n">carrier</span><span class="o">=</span><span class="n">carrier_map</span><span class="p">[</span><span class="n">generator</span><span class="p">],</span>
                <span class="n">marginal_cost</span><span class="o">=</span><span class="n">hist_efficiency</span>
                <span class="o">*</span> <span class="n">costs</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="s2">&quot;central coal CHP&quot;</span><span class="p">,</span> <span class="s2">&quot;VOM&quot;</span><span class="p">],</span>  <span class="c1"># NB: VOM is per MWel</span>
                <span class="n">p_nom</span><span class="o">=</span><span class="n">capacity</span> <span class="o">/</span> <span class="n">hist_efficiency</span> <span class="o">*</span> <span class="n">costs</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="s2">&quot;central coal CHP&quot;</span><span class="p">,</span> <span class="s2">&quot;c_v&quot;</span><span class="p">],</span>
                <span class="n">p_nom_min</span><span class="o">=</span><span class="n">capacity</span> <span class="o">/</span> <span class="n">hist_efficiency</span> <span class="o">*</span> <span class="n">costs</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="s2">&quot;central coal CHP&quot;</span><span class="p">,</span> <span class="s2">&quot;c_v&quot;</span><span class="p">],</span>
                <span class="n">p_nom_extendable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">efficiency</span><span class="o">=</span><span class="n">hist_efficiency</span> <span class="o">/</span> <span class="n">costs</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="s2">&quot;central coal CHP&quot;</span><span class="p">,</span> <span class="s2">&quot;c_v&quot;</span><span class="p">],</span>
                <span class="n">build_year</span><span class="o">=</span><span class="n">build_year</span><span class="p">,</span>
                <span class="n">lifetime</span><span class="o">=</span><span class="n">costs</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="s2">&quot;central coal CHP&quot;</span><span class="p">,</span> <span class="s2">&quot;lifetime&quot;</span><span class="p">],</span>
                <span class="n">location</span><span class="o">=</span><span class="n">buses</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="n">generator</span> <span class="o">==</span> <span class="s2">&quot;CHP gas&quot;</span><span class="p">:</span>
            <span class="n">hist_efficiency</span> <span class="o">=</span> <span class="mf">0.37</span>
            <span class="n">bus0</span> <span class="o">=</span> <span class="n">buses</span> <span class="o">+</span> <span class="s2">&quot; gas&quot;</span>
            <span class="n">n</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                <span class="s2">&quot;Link&quot;</span><span class="p">,</span>
                <span class="n">capacity</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                <span class="n">suffix</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;-</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">grouping_year</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">bus0</span><span class="o">=</span><span class="n">bus0</span><span class="p">,</span>
                <span class="n">bus1</span><span class="o">=</span><span class="n">capacity</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                <span class="n">carrier</span><span class="o">=</span><span class="n">carrier_map</span><span class="p">[</span><span class="n">generator</span><span class="p">],</span>
                <span class="n">marginal_cost</span><span class="o">=</span><span class="n">hist_efficiency</span>
                <span class="o">*</span> <span class="n">costs</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="s2">&quot;central gas CHP&quot;</span><span class="p">,</span> <span class="s2">&quot;VOM&quot;</span><span class="p">],</span>  <span class="c1"># NB: VOM is per MWel</span>
                <span class="n">capital_cost</span><span class="o">=</span><span class="n">hist_efficiency</span>
                <span class="o">*</span> <span class="n">costs</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="s2">&quot;central gas CHP&quot;</span><span class="p">,</span> <span class="s2">&quot;capital_cost&quot;</span><span class="p">],</span>  <span class="c1"># NB: fixed cost is per MWel,</span>
                <span class="n">p_nom</span><span class="o">=</span><span class="n">capacity</span> <span class="o">/</span> <span class="n">hist_efficiency</span><span class="p">,</span>
                <span class="n">p_nom_min</span><span class="o">=</span><span class="n">capacity</span> <span class="o">/</span> <span class="n">hist_efficiency</span><span class="p">,</span>
                <span class="n">p_nom_extendable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">efficiency</span><span class="o">=</span><span class="n">hist_efficiency</span><span class="p">,</span>
                <span class="n">p_nom_ratio</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                <span class="n">c_b</span><span class="o">=</span><span class="n">costs</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="s2">&quot;central gas CHP&quot;</span><span class="p">,</span> <span class="s2">&quot;c_b&quot;</span><span class="p">],</span>
                <span class="n">build_year</span><span class="o">=</span><span class="n">build_year</span><span class="p">,</span>
                <span class="n">lifetime</span><span class="o">=</span><span class="n">costs</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="s2">&quot;central gas CHP&quot;</span><span class="p">,</span> <span class="s2">&quot;lifetime&quot;</span><span class="p">],</span>
                <span class="n">location</span><span class="o">=</span><span class="n">buses</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">n</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                <span class="s2">&quot;Link&quot;</span><span class="p">,</span>
                <span class="n">capacity</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                <span class="n">suffix</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot; boiler-</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">grouping_year</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">bus0</span><span class="o">=</span><span class="n">bus0</span><span class="p">,</span>
                <span class="n">bus1</span><span class="o">=</span><span class="n">capacity</span><span class="o">.</span><span class="n">index</span> <span class="o">+</span> <span class="s2">&quot; central heat&quot;</span><span class="p">,</span>
                <span class="n">carrier</span><span class="o">=</span><span class="n">carrier_map</span><span class="p">[</span><span class="n">generator</span><span class="p">],</span>
                <span class="n">marginal_cost</span><span class="o">=</span><span class="n">hist_efficiency</span>
                <span class="o">*</span> <span class="n">costs</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="s2">&quot;central gas CHP&quot;</span><span class="p">,</span> <span class="s2">&quot;VOM&quot;</span><span class="p">],</span>  <span class="c1"># NB: VOM is per MWel</span>
                <span class="n">p_nom</span><span class="o">=</span><span class="n">capacity</span> <span class="o">/</span> <span class="n">hist_efficiency</span> <span class="o">*</span> <span class="n">costs</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="s2">&quot;central gas CHP&quot;</span><span class="p">,</span> <span class="s2">&quot;c_v&quot;</span><span class="p">],</span>
                <span class="n">p_nom_min</span><span class="o">=</span><span class="n">capacity</span> <span class="o">/</span> <span class="n">hist_efficiency</span> <span class="o">*</span> <span class="n">costs</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="s2">&quot;central gas CHP&quot;</span><span class="p">,</span> <span class="s2">&quot;c_v&quot;</span><span class="p">],</span>
                <span class="n">p_nom_extendable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">efficiency</span><span class="o">=</span><span class="n">hist_efficiency</span> <span class="o">/</span> <span class="n">costs</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="s2">&quot;central gas CHP&quot;</span><span class="p">,</span> <span class="s2">&quot;c_v&quot;</span><span class="p">],</span>
                <span class="n">build_year</span><span class="o">=</span><span class="n">build_year</span><span class="p">,</span>
                <span class="n">lifetime</span><span class="o">=</span><span class="n">costs</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="s2">&quot;central gas CHP&quot;</span><span class="p">,</span> <span class="s2">&quot;lifetime&quot;</span><span class="p">],</span>
                <span class="n">location</span><span class="o">=</span><span class="n">buses</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="n">generator</span> <span class="o">==</span> <span class="s2">&quot;coal boiler&quot;</span><span class="p">:</span>
            <span class="n">bus0</span> <span class="o">=</span> <span class="n">buses</span> <span class="o">+</span> <span class="s2">&quot; coal&quot;</span>
            <span class="k">for</span> <span class="n">cat</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot; central &quot;</span><span class="p">]:</span>
                <span class="n">n</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                    <span class="s2">&quot;Link&quot;</span><span class="p">,</span>
                    <span class="n">capacity</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                    <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;&quot;</span> <span class="o">+</span> <span class="n">cat</span> <span class="o">+</span> <span class="n">generator</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">grouping_year</span><span class="p">),</span>
                    <span class="n">bus0</span><span class="o">=</span><span class="n">bus0</span><span class="p">,</span>
                    <span class="n">bus1</span><span class="o">=</span><span class="n">capacity</span><span class="o">.</span><span class="n">index</span> <span class="o">+</span> <span class="n">cat</span> <span class="o">+</span> <span class="s2">&quot;heat&quot;</span><span class="p">,</span>
                    <span class="n">carrier</span><span class="o">=</span><span class="n">carrier_map</span><span class="p">[</span><span class="n">generator</span><span class="p">],</span>
                    <span class="n">marginal_cost</span><span class="o">=</span><span class="n">costs</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">cat</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span> <span class="o">+</span> <span class="n">generator</span><span class="p">,</span> <span class="s2">&quot;efficiency&quot;</span><span class="p">]</span>
                    <span class="o">*</span> <span class="n">costs</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">cat</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span> <span class="o">+</span> <span class="n">generator</span><span class="p">,</span> <span class="s2">&quot;VOM&quot;</span><span class="p">],</span>
                    <span class="n">capital_cost</span><span class="o">=</span><span class="n">costs</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">cat</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span> <span class="o">+</span> <span class="n">generator</span><span class="p">,</span> <span class="s2">&quot;efficiency&quot;</span><span class="p">]</span>
                    <span class="o">*</span> <span class="n">costs</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">cat</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span> <span class="o">+</span> <span class="n">generator</span><span class="p">,</span> <span class="s2">&quot;capital_cost&quot;</span><span class="p">],</span>
                    <span class="n">p_nom</span><span class="o">=</span><span class="n">capacity</span> <span class="o">/</span> <span class="n">costs</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">cat</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span> <span class="o">+</span> <span class="n">generator</span><span class="p">,</span> <span class="s2">&quot;efficiency&quot;</span><span class="p">],</span>
                    <span class="n">p_nom_min</span><span class="o">=</span><span class="n">capacity</span> <span class="o">/</span> <span class="n">costs</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">cat</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span> <span class="o">+</span> <span class="n">generator</span><span class="p">,</span> <span class="s2">&quot;efficiency&quot;</span><span class="p">],</span>
                    <span class="n">p_nom_extendable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">efficiency</span><span class="o">=</span><span class="n">costs</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">cat</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span> <span class="o">+</span> <span class="n">generator</span><span class="p">,</span> <span class="s2">&quot;efficiency&quot;</span><span class="p">],</span>
                    <span class="n">build_year</span><span class="o">=</span><span class="n">build_year</span><span class="p">,</span>
                    <span class="n">lifetime</span><span class="o">=</span><span class="n">costs</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">cat</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span> <span class="o">+</span> <span class="n">generator</span><span class="p">,</span> <span class="s2">&quot;lifetime&quot;</span><span class="p">],</span>
                    <span class="n">location</span><span class="o">=</span><span class="n">buses</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="c1"># TODO fix read operation in func, fix snakemake in function, make air pumps?</span>
        <span class="k">elif</span> <span class="n">generator</span> <span class="o">==</span> <span class="s2">&quot;heat pump&quot;</span><span class="p">:</span>
            <span class="c1"># TODO separate the read operation from the add operation</span>
            <span class="k">with</span> <span class="n">pd</span><span class="o">.</span><span class="n">HDFStore</span><span class="p">(</span><span class="n">snakemake</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">cop_name</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">store</span><span class="p">:</span>
                <span class="n">gshp_cop</span> <span class="o">=</span> <span class="n">store</span><span class="p">[</span><span class="s2">&quot;gshp_cop_profiles&quot;</span><span class="p">]</span>
                <span class="n">gshp_cop</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">gshp_cop</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="n">gshp_cop</span> <span class="o">=</span> <span class="n">shift_profile_to_planning_year</span><span class="p">(</span>
                    <span class="n">gshp_cop</span><span class="p">,</span> <span class="n">snakemake</span><span class="o">.</span><span class="n">wildcards</span><span class="o">.</span><span class="n">planning_horizons</span>
                <span class="p">)</span>
                <span class="n">gshp_cop</span> <span class="o">=</span> <span class="n">gshp_cop</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">snapshots</span><span class="p">]</span>
            <span class="n">n</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                <span class="s2">&quot;Link&quot;</span><span class="p">,</span>
                <span class="n">capacity</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">grouping_year</span><span class="p">),</span>
                <span class="n">bus0</span><span class="o">=</span><span class="n">capacity</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                <span class="n">bus1</span><span class="o">=</span><span class="n">capacity</span><span class="o">.</span><span class="n">index</span> <span class="o">+</span> <span class="s2">&quot; central heat&quot;</span><span class="p">,</span>
                <span class="n">carrier</span><span class="o">=</span><span class="s2">&quot;heat pump&quot;</span><span class="p">,</span>
                <span class="n">efficiency</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">gshp_cop</span><span class="p">[</span><span class="n">capacity</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;time_dep_hp_cop&quot;</span><span class="p">]</span>
                    <span class="k">else</span> <span class="n">costs</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="s2">&quot;decentral ground-sourced heat pump&quot;</span><span class="p">,</span> <span class="s2">&quot;efficiency&quot;</span><span class="p">]</span>
                <span class="p">),</span>
                <span class="n">capital_cost</span><span class="o">=</span><span class="n">costs</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="s2">&quot;decentral ground-sourced heat pump&quot;</span><span class="p">,</span> <span class="s2">&quot;efficiency&quot;</span><span class="p">]</span>
                <span class="o">*</span> <span class="n">costs</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="s2">&quot;decentral ground-sourced heat pump&quot;</span><span class="p">,</span> <span class="s2">&quot;capital_cost&quot;</span><span class="p">],</span>
                <span class="n">marginal_cost</span><span class="o">=</span><span class="n">costs</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="s2">&quot;decentral ground-sourced heat pump&quot;</span><span class="p">,</span> <span class="s2">&quot;efficiency&quot;</span><span class="p">]</span>
                <span class="o">*</span> <span class="n">costs</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="s2">&quot;decentral ground-sourced heat pump&quot;</span><span class="p">,</span> <span class="s2">&quot;marginal_cost&quot;</span><span class="p">],</span>
                <span class="n">p_nom</span><span class="o">=</span><span class="n">capacity</span> <span class="o">/</span> <span class="n">costs</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="s2">&quot;decentral ground-sourced heat pump&quot;</span><span class="p">,</span> <span class="s2">&quot;efficiency&quot;</span><span class="p">],</span>
                <span class="n">p_nom_min</span><span class="o">=</span><span class="n">capacity</span> <span class="o">/</span> <span class="n">costs</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="s2">&quot;decentral ground-sourced heat pump&quot;</span><span class="p">,</span> <span class="s2">&quot;efficiency&quot;</span><span class="p">],</span>
                <span class="n">p_nom_extendable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">build_year</span><span class="o">=</span><span class="n">build_year</span><span class="p">,</span>
                <span class="n">lifetime</span><span class="o">=</span><span class="n">costs</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="s2">&quot;decentral ground-sourced heat pump&quot;</span><span class="p">,</span> <span class="s2">&quot;lifetime&quot;</span><span class="p">],</span>
                <span class="n">location</span><span class="o">=</span><span class="n">buses</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Skipped existing capacitity for </span><span class="si">{</span><span class="n">generator</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="o">+</span> <span class="s2">&quot; - tech not implemented as existing capacity&quot;</span>
            <span class="p">)</span>

    <span class="k">return</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="add_existing_baseyear.distribute_vre_by_grade" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">distribute_vre_by_grade</span><span class="p">(</span><span class="n">cap_by_year</span><span class="p">,</span> <span class="n">grade_capacities</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>distribute vre capacities by grade potential, use up better grades first</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>cap_by_year</code>
            </td>
            <td>
                  <code><span title="pandas.Series">Series</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>the vre tech potential p_nom_max added per year</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>grade_capacities</code>
            </td>
            <td>
                  <code><span title="pandas.Series">Series</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>the vre grade potential for the tech and bus</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Returns:
    pd.DataFrame: DataFrame with the distributed vre capacities (shape: years x buses)</p>


            <details class="quote">
              <summary>Source code in <code>workflow/scripts/add_existing_baseyear.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">distribute_vre_by_grade</span><span class="p">(</span><span class="n">cap_by_year</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">grade_capacities</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;distribute vre capacities by grade potential, use up better grades first</span>

<span class="sd">    Args:</span>
<span class="sd">        cap_by_year (pd.Series): the vre tech potential p_nom_max added per year</span>
<span class="sd">        grade_capacities (pd.Series): the vre grade potential for the tech and bus</span>
<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: DataFrame with the distributed vre capacities (shape: years x buses)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">availability</span> <span class="o">=</span> <span class="n">cap_by_year</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">to_distribute</span> <span class="o">=</span> <span class="n">grade_capacities</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
    <span class="n">n_years</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">to_distribute</span><span class="p">)</span>
    <span class="n">n_sources</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">availability</span><span class="p">)</span>

    <span class="c1"># To store allocation per year per source (shape: sources x years)</span>
    <span class="n">allocation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_sources</span><span class="p">,</span> <span class="n">n_years</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">remaining</span> <span class="o">=</span> <span class="n">availability</span><span class="o">.</span><span class="n">values</span>

    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_years</span><span class="p">):</span>
        <span class="n">needed</span> <span class="o">=</span> <span class="n">to_distribute</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">cumsum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">remaining</span><span class="p">)</span>
        <span class="n">used_up</span> <span class="o">=</span> <span class="n">cumsum</span> <span class="o">&lt;</span> <span class="n">needed</span>
        <span class="n">cutoff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">cumsum</span> <span class="o">&gt;=</span> <span class="n">needed</span><span class="p">)</span>

        <span class="n">allocation</span><span class="p">[</span><span class="n">used_up</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">remaining</span><span class="p">[</span><span class="n">used_up</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">needed</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">cumsum</span><span class="p">[</span><span class="n">cutoff</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">cutoff</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">allocation</span><span class="p">[</span><span class="n">cutoff</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">needed</span> <span class="o">-</span> <span class="p">(</span><span class="n">cumsum</span><span class="p">[</span><span class="n">cutoff</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">cutoff</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Subtract what was used from availability</span>
        <span class="n">remaining</span> <span class="o">-=</span> <span class="n">allocation</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">allocation</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">grade_capacities</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">availability</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.92b07e13.min.js"></script>
      
    
  </body>
</html>